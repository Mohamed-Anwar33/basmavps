import Content from '../../models/Content.js';
import mongoose from 'mongoose';

// Get content for a specific page
const getPageContent = async (req, res) => {
  try {
    const { page } = req.params;
    
    console.log('๐ getPageContent - Requested page:', page);
    
    // Map page types to match the saved format
    const pageMapping = {
      'howToOrder': 'how-to-order',
      'how-to-order': 'how-to-order',
      'homepage': 'homepage',
      'about': 'about',
      'services': 'services',
      'contact': 'contact',
      'faq': 'faq',
      'blog': 'blog',
      'policies': 'policies'
    };
    
    const mappedPage = pageMapping[page] || page;
    console.log('๐ Mapped page name:', mappedPage);
    
    const content = await Content.find({ page: mappedPage }).select('key value type -_id');
    console.log('๐ Found content entries:', content.length);
    
    // Convert array to object for easier frontend usage
    const contentObject = {};
    content.forEach(item => {
      contentObject[item.key] = item.value;
    });

    console.log('๐ Content object keys:', Object.keys(contentObject));

    res.json({
      success: true,
      data: contentObject
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'รยรยดรโ รยรล รยฌรโรยจ รโฆรยญรยชรหรโฐ รยงรโรยตรยรยญรยฉ'
    });
  }
};

// Update content for a specific page
const updatePageContent = async (req, res) => {
  try {
    const { page } = req.params;
    const contentData = req.body;
    const adminId = req.user?.id || req.user?._id;
    
    console.log('๐ง UpdatePageContent Debug:');
    console.log('๐ Page:', page);
    console.log('๐ค Admin ID:', adminId);
    console.log('๐ Content Data:', JSON.stringify(contentData, null, 2));
    
    // Map page types to match the saved format (same as getPageContent)
    const pageMapping = {
      'howToOrder': 'how-to-order',
      'how-to-order': 'how-to-order',
      'homepage': 'homepage',
      'about': 'about',
      'services': 'services',
      'contact': 'contact',
      'faq': 'faq',
      'blog': 'blog',
      'policies': 'policies'
    };
    
    const mappedPage = pageMapping[page] || page;
    console.log('๐ Mapped page name for save:', mappedPage);
    
    // Validate admin ID
    if (!adminId) {
      return res.status(401).json({
        success: false,
        message: 'ูุนุฑู ุงูุฅุฏูู ูุทููุจ'
      });
    }

    const updates = [];

    // Process each content item
    for (const [key, value] of Object.entries(contentData)) {
      const updateData = {
        page: mappedPage,
        key,
        value,
        updatedBy: new mongoose.Types.ObjectId(adminId)
      };

      updates.push(
        Content.findOneAndUpdate(
          { page: mappedPage, key },
          updateData,
          { 
            upsert: true, 
            new: true,
            runValidators: true
          }
        )
      );
    }

    const results = await Promise.all(updates);
    
    // Return the saved content in the expected format
    const savedData = {};
    results.forEach(result => {
      if (result && result.key) {
        savedData[result.key] = result.value;
      }
    });

    res.json({
      success: true,
      data: savedData, // โ ุฃุถูุช ุงูู data ุงููุทููุจุฉ
      message: 'ุชู ุชุญุฏูุซ ุงููุญุชูู ุจูุฌุงุญ'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'รยรยดรโ รยรล รยชรยญรยฏรลรยซ รยงรโรโฆรยญรยชรหรโฐ'
    });
  }
};

// Get all pages with their content keys
const getAllPagesContent = async (req, res) => {
  try {
    const content = await Content.find().select('page key value type -_id');
    
    // Group content by page
    const pagesContent = {};
    content.forEach(item => {
      if (!pagesContent[item.page]) {
        pagesContent[item.page] = {};
      }
      pagesContent[item.page][item.key] = item.value;
    });

    res.json({
      success: true,
      data: pagesContent
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'รยรยดรโ รยรล รยฌรโรยจ รโฆรยญรยชรหรโฐ รยงรโรยตรยรยญรยงรยช'
    });
  }
};

// Delete specific content item
const deleteContentItem = async (req, res) => {
  try {
    const { page, key } = req.params;
    
    const deleted = await Content.findOneAndDelete({ page, key });
    
    if (!deleted) {
      return res.status(404).json({
        success: false,
        message: 'รยงรโรยนรโรยตรยฑ รยบรลรยฑ รโฆรหรยฌรหรยฏ'
      });
    }

    res.json({
      success: true,
      message: 'รยชรโฆ รยญรยฐรย รยงรโรยนรโรยตรยฑ รยจรโรยฌรยงรยญ'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'รยรยดรโ รยรล รยญรยฐรย รยงรโรยนรโรยตรยฑ'
    });
  }
};

// Seed default content for pages
const seedDefaultContent = async (req, res) => {
  try {
    const adminId = req.user?.id || req.user?._id;

    const defaultContent = {
      home: {
        heroTitle: 'รยจรยตรโฆรยฉ รยชรยตรโฆรลรโฆ - รโรยตรโรยน รยงรโรยฅรยจรยฏรยงรยน รยจรยตรยฑรลรยงรโน',
        heroSubtitle: 'รโรยญรโ รยรยฑรลรโ รโฆรโ รยงรโรโฆรยจรยฏรยนรลรโ รยงรโรโฆรยชรยฎรยตรยตรลรโ รยรล รยชรยตรโฆรลรโฆ รยงรโรโกรหรลรยฉ รยงรโรยจรยตรยฑรลรยฉ รหรยงรโรโฆรยญรยชรหรโฐ รยงรโรยฑรโรโฆรลรล รโรยณรยงรยนรยฏรฦ รยรล รยชรยฑรฦ รยจรยตรโฆรยฉ รโฆรโฆรลรยฒรยฉ รยรล รยนรยงรโรโฆรฦ รยงรโรยฑรโรโฆรล',
        ctaText: 'รยงรยจรยฏรยฃ รโฆรยดรยฑรหรยนรฦ',
        ctaLink: '/contact',
        foundationalTitle: 'รโรยครโฆรโ รยจรโรหรยฉ รยงรโรยชรยตรโฆรลรโฆ',
        foundationalDescription: 'รยงรโรยชรยตรโฆรลรโฆ รโรลรยณ รโฆรยฌรยฑรยฏ รยดรฦรโ รยฌรโฆรลรโรล รยจรโ รโกรห รโรยบรยฉ รยชรยชรยญรยฏรยซ รโฆรยน รยฌรโฆรโกรหรยฑรฦ รหรยชรโรโรโ รยฑรยณรยงรโรยชรฦ รยจรหรยถรหรยญ รหรยชรยฃรยซรลรยฑ',
        servicesTitle: 'รยฎรยฏรโฆรยงรยชรโรยง รยงรโรโฆรยชรโฆรลรยฒรยฉ',
        servicesDescription: 'รโรโรยฏรโฆ รโฆรยฌรโฆรหรยนรยฉ รยดรยงรโฆรโรยฉ รโฆรโ รยงรโรยฎรยฏรโฆรยงรยช รยงรโรโฆรยชรยฎรยตรยตรยฉ รยรล รยงรโรยชรยตรโฆรลรโฆ รหรยงรโรโฆรยญรยชรหรโฐ รยงรโรยฑรโรโฆรล',
        showCounters: true,
        countersTitle: 'รยฃรยฑรโรยงรโฆรโรยง รยชรยชรยญรยฏรยซ'
      },
      about: {
        heroTitle: 'รโรยญรโ รโรยง รโรโรยงรยรยณ รยนรโรโฐ รยงรโรยดรฦรโรล รยจรโ รยนรโรโฐ รยงรโรยฃรยซรยฑ',
        heroSubtitle: 'รยรล รยจรยตรโฆรยฉ รยชรยตรโฆรลรโฆรล รโรยครโฆรโ รยฃรโ รยงรโรยชรยตรโฆรลรโฆ รยงรโรยญรโรลรโรล รโรยง รลรโรยชรยตรยฑ รยนรโรโฐ รยงรโรยฌรโฆรยงรโ รยงรโรยจรยตรยฑรลรล รยจรโ รลรโฆรยชรยฏ รโรลรยดรโฆรโ รยงรโรโรยฏรยฑรยฉ รยนรโรโฐ รยชรยฑรฦ รยฃรยซรยฑ รยฅรลรยฌรยงรยจรล รหรยฏรยงรยฆรโฆ รยรล รโรยรหรยณ รยงรโรยฌรโฆรโกรหรยฑ',
        missionTitle: 'รยฑรยณรยงรโรยชรโรยง',
        missionDesc: 'รโรยณรยนรโฐ รโรยฃรโ รโรฦรหรโ รยงรโรยดรยฑรลรฦ รยงรโรยฅรยจรยฏรยงรยนรล รยงรโรโฆรหรยซรหรโ รโรฦรโ รโฆรโ รลรยฑรลรยฏ รยฃรโ รลรยชรยฑรฦ รยจรยตรโฆรยฉ รโฆรโฆรลรยฒรยฉ รยรล รยนรยงรโรโฆรโก รยงรโรยฑรโรโฆรล. รโรยญรโ รโรยครโฆรโ รยจรโรหรยฉ รยงรโรยชรยตรโฆรลรโฆ รยรล รยชรยบรลรลรยฑ รยงรโรยทรยฑรลรโรยฉ รยงรโรยชรล รลรโรยธรยฑ รยจรโกรยง รยงรโรยนรยงรโรโฆ รโรยนรโรยงรโฆรยชรฦ รยงรโรยชรยฌรยงรยฑรลรยฉ.',
        visionTitle: 'รยฑรยครลรยชรโรยง รโรโรโฆรยณรยชรโรยจรโ',
        visionBody: 'รโรยทรโฆรยญ รโรยฃรโ รโรฦรหรโ รยงรโรยงรยณรโฆ รยงรโรยฃรหรโ รยงรโรยฐรล รลรยชรยจรยงรยฏรยฑ รโรโรยฐรโกรโ รยนรโรยฏรโฆรยง รลรยรฦรยฑ รยฃรยญรยฏรโกรโฆ รยรล รยงรโรยชรยตรโฆรลรโฆ รหรยงรโรยฅรยจรยฏรยงรยน รยรล รยงรโรโฆรโรยทรโรยฉ รยงรโรยนรยฑรยจรลรยฉ. รโรยฑรลรยฏ รยฃรโ รโรยณรยงรโกรโฆ รยรล รยฑรยรยน รโฆรยณรยชรหรโฐ รยงรโรยชรยตรโฆรลรโฆ รยงรโรยนรยฑรยจรล รหรโรยฌรยนรโรโก รโฆรโรยงรยรยณรยงรโน รยนรยงรโรโฆรลรยงรโน.',
        ctaPrimaryText: 'รยชรหรยงรยตรโ รโฆรยนรโรยง',
        ctaPrimaryLink: '/contact',
        ctaSecondaryText: 'รยชรยนรยฑรย รยนรโรโฐ รยฎรยฏรโฆรยงรยชรโรยง',
        ctaSecondaryLink: '/services'
      },
      services: {
        heroTitle: 'รยฎรยฏรโฆรยงรยชรโรยง รยงรโรโฆรยชรโฆรลรยฒรยฉ',
        heroDescription: 'รโรโรยฏรโฆ รโฆรยฌรโฆรหรยนรยฉ รยดรยงรโฆรโรยฉ รโฆรโ รยงรโรยฎรยฏรโฆรยงรยช รยงรโรโฆรยชรยฎรยตรยตรยฉ รยรล รยงรโรยชรยตรโฆรลรโฆ รหรยงรโรยชรยทรหรลรยฑ รโรโฆรยณรยงรยนรยฏรยชรฦ รยรล รยชรยญรโรลรโ รยฃรโกรยฏรยงรยรฦ รยงรโรยฑรโรโฆรลรยฉ',
        showFeatured: true,
        featuredTitle: 'รยฎรยฏรโฆรยงรยชรโรยง รยงรโรโฆรโฆรลรยฒรยฉ',
        processTitle: 'รยนรโฆรโรลรยชรโรยง รยงรโรยฅรยจรยฏรยงรยนรลรยฉ',
        processDescription: 'รโฆรโรโกรยฌรลรยฉ รโฆรยฏรยฑรหรยณรยฉ รโรยชรยจรยนรโกรยง รโฆรยน รฦรโ รโฆรยดรยฑรหรยน รโรยถรโฆรยงรโ รยงรโรยญรยตรหรโ รยนรโรโฐ รยฃรยรยถรโ รยงรโรโรยชรยงรยฆรยฌ'
      },
      contact: {
        pageTitle: 'รยชรหรยงรยตรโ รโฆรยนรโรยง',
        pageDescription: 'รโรยญรโ รโกรโรยง รโรโฆรยณรยงรยนรยฏรยชรฦ รยรล รยชรยญรโรลรโ รยฑรยครลรยชรฦ. รยชรหรยงรยตรโ รโฆรยนรโรยง รยงรโรลรหรโฆ รหรยงรยญรยตรโ รยนรโรโฐ รยงรยณรยชรยดรยงรยฑรยฉ รโฆรยฌรยงรโรลรยฉ รโรโฆรยดรยฑรหรยนรฦ',
        officeAddress: 'รยงรโรยฑรลรยงรยถรล รยงรโรโฆรโฆรโรฦรยฉ รยงรโรยนรยฑรยจรลรยฉ รยงรโรยณรยนรหรยฏรลรยฉ',
        phoneNumber: '+966XXXXXXXXX',
        whatsappNumber: '+966XXXXXXXXX',
        emailAddress: 'info@basmatdesign.com',
        workingHours: 'รยงรโรยฃรยญรยฏ - รยงรโรยฎรโฆรลรยณ: 9:00 รยต - 6:00 รโฆ',
        socialLinks: 'รยชรหรลรยชรยฑ: @basmatdesign\nรยฅรโรยณรยชรยบรยฑรยงรโฆ: @basmatdesign\nรโรลรโรฦรยฏ รยฅรโ: basmat-design'
      },
      faq: {
        pageTitle: 'รยงรโรยฃรยณรยฆรโรยฉ รยงรโรยดรยงรยฆรยนรยฉ',
        pageDescription: 'รยฅรยฌรยงรยจรยงรยช รยนรโรโฐ รยฃรฦรยซรยฑ รยงรโรยฃรยณรยฆรโรยฉ รยดรลรหรยนรยงรโน รยญรหรโ รยฎรยฏรโฆรยงรยชรโรยง รหรยทรยฑรลรโรยฉ รยนรโฆรโรโรยง',
        introText: 'รโรยฌรลรยจ รโกรโรยง รยนรโรโฐ รยฃรฦรยซรยฑ รยงรโรยฃรยณรยฆรโรยฉ รยงรโรยชรล รยชรยฑรยฏรโรยง รโฆรโ รยนรโฆรโรยงรยฆรโรยง. รยฅรยฐรยง รโรโฆ รยชรยฌรยฏ รยฅรยฌรยงรยจรยฉ รยณรยครยงรโรฦรล รโรยง รยชรยชรยฑรยฏรยฏ รยรล รยงรโรยชรหรยงรยตรโ รโฆรยนรโรยง รโฆรยจรยงรยดรยฑรยฉ.',
        contactText: 'รโรโฆ รยชรยฌรยฏ รยฅรยฌรยงรยจรยฉ รยณรยครยงรโรฦรลธ รยชรหรยงรยตรโ รโฆรยนรโรยง รหรยณรโรยฌรลรยจ รยนรโรโฐ รยฌรโฆรลรยน รยงรยณรยชรยรยณรยงรยฑรยงรยชรฦ รยรล รยฃรยณรยฑรยน รหรโรยช รโฆรโฆรฦรโ.'
      },
      blog: {
        pageTitle: 'รโฆรยฏรหรโรยฉ รยจรยตรโฆรยฉ รยชรยตรโฆรลรโฆ',
        pageDescription: 'รยงรฦรยชรยดรย รยฃรยญรยฏรยซ รยงรโรโฆรโรยงรโรยงรยช รหรยงรโรโรยตรยงรยฆรยญ รยรล รยนรยงรโรโฆ รยงรโรยชรยตรโฆรลรโฆ รหรยงรโรยฅรยจรยฏรยงรยน รยงรโรยฑรโรโฆรล',
        featuredTitle: 'รยงรโรโฆรโรยงรโรยงรยช รยงรโรโฆรโฆรลรยฒรยฉ',
        showCategories: true,
        postsPerPage: '12'
      },
      'how-to-order': {
        pageTitle: 'รฦรลรย รยชรยทรโรยจ รยฎรยฏรโฆรยชรฦ',
        pageDescription: 'รยฏรโรลรโ รยดรยงรโฆรโ รโรยทรโรยจ รยฎรยฏรโฆรยงรยชรโรยง รหรยงรโรยญรยตรหรโ รยนรโรโฐ รยฃรยรยถรโ รยงรโรโรยชรยงรยฆรยฌ',
        introText: 'รโรยญรโ รโรยฌรยนรโ รยนรโฆรโรลรยฉ รยทรโรยจ รยงรโรยฎรยฏรโฆรยฉ รยณรโกรโรยฉ รหรโฆรยฑรลรยญรยฉ. รยงรยชรยจรยน รโกรยฐรโก รยงรโรยฎรยทรหรยงรยช รยงรโรยจรยณรลรยทรยฉ รโรโรยญรยตรหรโ รยนรโรโฐ รยฎรยฏรโฆรยชรฦ รยงรโรโฆรยทรโรหรยจรยฉ.',
        stepsTitle: 'รยฎรยทรหรยงรยช รยงรโรยทรโรยจ',
        contactInfo: 'รโรโรโฆรยณรยงรยนรยฏรยฉ รหรยงรโรยงรยณรยชรยรยณรยงรยฑรยงรยช:\nรหรยงรยชรยณรยงรยจ: +966XXXXXXXXX\nรยฅรลรโฆรลรโ: info@basmatdesign.com'
      },
      policies: {
        pageTitle: 'รยงรโรยณรลรยงรยณรยงรยช รหรยงรโรยดรยฑรหรยท',
        lastUpdated: '2024-01-01',
        privacyPolicy: 'รยณรลรยงรยณรยฉ รยงรโรยฎรยตรหรยตรลรยฉ รยชรยชรยถรโฆรโ รฦรลรยรลรยฉ รยฌรโฆรยน รหรยงรยณรยชรยฎรยฏรยงรโฆ รยงรโรยจรลรยงรโรยงรยช รยงรโรยดรยฎรยตรลรยฉ...',
        termsOfService: 'รยดรยฑรหรยท รยงรโรยงรยณรยชรยฎรยฏรยงรโฆ รยชรยญรยฏรยฏ รยงรโรโรหรยงรยนรยฏ รหรยงรโรยฅรยฑรยดรยงรยฏรยงรยช รโรยงรยณรยชรยฎรยฏรยงรโฆ รโฆรหรโรยนรโรยง รหรยฎรยฏรโฆรยงรยชรโรยง...',
        refundPolicy: 'รยณรลรยงรยณรยฉ รยงรโรยงรยณรยชรยนรยงรยฏรยฉ รยชรยญรยฏรยฏ รยงรโรยดรยฑรหรยท รหรยงรโรยฃรยญรฦรยงรโฆ รโรโรยญรยตรหรโ รยนรโรโฐ รยงรยณรยชรยฑรยฏรยงรยฏ รยงรโรยฃรโฆรหรยงรโ...',
        cookiePolicy: 'รยณรลรยงรยณรยฉ รโฆรโรยรยงรยช รยชรยนรยฑรลรย รยงรโรยงรยฑรยชรยจรยงรยท รยชรหรยถรยญ รฦรลรยรลรยฉ รยงรยณรยชรยฎรยฏรยงรโฆรโรยง รโรโรฦรหรฦรลรยฒ...'
      }
    };

    const operations = [];

    for (const [page, content] of Object.entries(defaultContent)) {
      for (const [key, value] of Object.entries(content)) {
        operations.push(
          Content.findOneAndUpdate(
            { page, key },
            { 
              page, 
              key, 
              value, 
              updatedBy: new mongoose.Types.ObjectId(adminId),
              type: typeof value === 'boolean' ? 'boolean' : 'text'
            },
            { 
              upsert: true, 
              new: true,
              runValidators: true
            }
          )
        );
      }
    }

    await Promise.all(operations);

    res.json({
      success: true,
      message: 'รยชรโฆ รยฅรโรยดรยงรยก รยงรโรโฆรยญรยชรหรโฐ รยงรโรยงรยรยชรยฑรยงรยถรล รยจรโรยฌรยงรยญ'
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: 'รยรยดรโ รยรล รยฅรโรยดรยงรยก รยงรโรโฆรยญรยชรหรโฐ รยงรโรยงรยรยชรยฑรยงรยถรล'
    });
  }
};

export {
  getPageContent,
  updatePageContent,
  getAllPagesContent,
  deleteContentItem,
  seedDefaultContent
};

